<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange givr√©e - Rusticit√© & R√©colte</title>

    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='leafGradient' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%234CAF50;stop-opacity:1' /><stop offset='100%' style='stop-color:%2366BB6A;stop-opacity:1' /></linearGradient><radialGradient id='dropGradient' cx='50%' cy='50%' r='50%' fx='50%' fy='50%'><stop offset='0%' style='stop-color:rgb(255,255,255);stop-opacity:0.9' /><stop offset='100%' style='stop-color:rgb(173,216,230);stop-opacity:0.6' /></radialGradient></defs><path d='M 30 70 Q 10 50 40 20 Q 70 5 90 30 Q 80 60 55 85 L 30 70 Z' fill='url(%23leafGradient)'/><circle cx='50' cy='50' r='10' fill='url(%23dropGradient)' stroke='%2387CEEB' stroke-width='1'/></svg>" type="image/svg+xml">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; height: 100vh; background: #f8fafc; color: #1e293b; }
        #map { flex: 1; height: 100%; background: #cbd5e1; }
        #sidebar { width: 420px; background: #fff; border-left: 1px solid #e2e8f0; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; }
        h2 { color: #c2410c; margin: 0 0 15px 0; display: flex; align-items: center; gap: 10px; }

        .period-selector { margin-bottom: 15px; padding: 15px; background: #fff7ed; border-radius: 12px; border: 1px solid #ffedd5; }
        #station-info { margin-bottom: 20px; padding: 15px; background: #f1f5f9; border-radius: 12px; border: 1px solid #e2e8f0; }
        #station-name { color: #1e293b; font-weight: 800; font-size: 1.1em; display: block; margin-bottom: 5px;}

        .agrume-card { padding: 16px; margin-bottom: 12px; border-radius: 10px; background: #fff; border: 1px solid #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

        /* Hi√©rarchie des couleurs mise √† jour */
        .status-ok { border-left: 6px solid #16a34a; background: #f0fdf4; }      /* VERT : Succ√®s total */
        .status-early { border-left: 6px solid #eab308; background: #fffbeb; }   /* JAUNE : Opportunit√© (partiel) */
        .status-warning { border-left: 6px solid #f97316; background: #fff7ed; } /* ORANGE : Risque gel fruits */
        .status-ko { border-left: 6px solid #ef4444; opacity: 0.75; background: #fef2f2; } /* ROUGE : Gel arbre */

        .temp-tag { background: #fee2e2; padding: 1px 4px; border-radius: 4px; font-family: ui-monospace, monospace; font-weight: 700; color: #991b1b; font-size: 0.85em; }
        .badge { display: inline-block; font-size: 0.7em; padding: 3px 8px; border-radius: 6px; font-weight: 700; margin-top: 10px; margin-right: 5px; text-transform: uppercase; }
        .badge-fruit { background: #f97316; color: white; }
        .badge-recolte { background: #3b82f6; color: white; }

        .legend { padding: 12px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-size: 0.85em; color: #475569; }
        .legend h4 { margin: 0 0 8px 0; color: #1e293b; font-size: 1em; }
        .legend-item { display: flex; align-items: center; margin-bottom: 5px; }
        .legend-item i { width: 14px; height: 14px; margin-right: 10px; border-radius: 50%; border: 1px solid rgba(0,0,0,0.1); flex-shrink: 0; }

        .source-mention { font-size: 0.75em; color: #94a3b8; margin-top: auto; padding-top: 20px; text-align: center; line-height: 1.4; }
        .source-mention a { color: #3b82f6; text-decoration: none; }
        select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #fed7aa; margin-top: 8px; cursor: pointer; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="sidebar">
    <h2>Orange givr√©e <span>‚ùÑÔ∏èüçä</span></h2>
    <div class="period-selector">
        <label for="period-select"><strong>Fen√™tre d'analyse :</strong></label>
        <select id="period-select" onchange="refreshView()">
            <option value="last_5y" selected>Climat r√©cent (5 derni√®res ann√©es)</option>
            <option value="last_10y">Tendance (10 derni√®res ann√©es)</option>
            <option value="last_20y">Historique (20 derni√®res ann√©es)</option>
        </select>
    </div>
    <div id="station-info">
        <span id="station-name">S√©lectionnez une station</span>
        <small id="min-display" style="color: #64748b;">Record de froid : - ¬∞C</small>
    </div>
    <div id="agrumes-container">
        <p style="color: #94a3b8; font-style: italic; text-align: center; margin-top: 40px;">Cliquez sur un point de la carte.</p>
    </div>
    <div class="source-mention">
        Donn√©es m√©t√©o : <a href="https://www.data.gouv.fr/datasets/donnees-climatologiques-de-base-quotidiennes" target="_blank">M√©t√©o-France (Data.gouv.fr)</a>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([46.5, 2.5], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let agrumesData = [];
    let geojsonData = null;
    let geojsonLayer = null;
    let currentFeature = null;
    const monthNames = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Juin", "Juil", "Ao√ªt", "Sept", "Oct", "Nov", "D√©c"];

    function getColor(t) {
        return t > 0 ? '#16a34a' : t > -5 ? '#84cc16' : t > -8 ? '#eab308' : t > -10 ? '#f97316' : t > -12 ? '#ef4444' : t > -15 ? '#dc2626' : '#7f1d1d';
    }

    fetch('agrumes.json').then(res => res.json()).then(data => { agrumesData = data; });
    fetch('stations_temperatures.geojson').then(res => res.json()).then(data => { geojsonData = data; renderMap(); });

    function renderMap() {
        const period = document.getElementById('period-select').value;
        if (geojsonLayer) map.removeLayer(geojsonLayer);
        geojsonLayer = L.geoJSON(geojsonData, {
            filter: (f) => f.properties[period] && f.properties[period].min_absolute !== null,
            pointToLayer: (f, latlng) => L.circleMarker(latlng, {
                radius: 8, fillColor: getColor(f.properties[period].min_absolute),
                color: "#fff", weight: 0.8, fillOpacity: 0.9
            }),
            onEachFeature: (f, layer) => {
                layer.on('mouseover', function() { this.setRadius(12); this.setStyle({weight: 2}); });
                layer.on('mouseout', function() { this.setRadius(8); this.setStyle({weight: 0.8}); });
                layer.on('click', () => { currentFeature = f; updateSidebarContent(); });
                layer.bindTooltip(`<b>${f.properties.nom}</b>: ${f.properties[period].min_absolute}¬∞C`, {direction:'top', offset:[0,-10]});
            }
        }).addTo(map);
    }

    function refreshView() { renderMap(); if (currentFeature) updateSidebarContent(); }

    function updateSidebarContent() {
        const period = document.getElementById('period-select').value;
        const props = currentFeature.properties;
        const periodStats = props[period];
        const minAbs = periodStats.min_absolute;

        document.getElementById('station-name').innerText = props.nom;
        document.getElementById('min-display').innerText = `Record de froid sur la p√©riode : ${minAbs}¬∞C`;

        const container = document.getElementById('agrumes-container');
        container.innerHTML = "";

        const processed = agrumesData.map(agr => {
            const survitArbre = minAbs > agr.seuil_arbre;
            let moisSains = [];
            let moisGeles = [];

            agr.recolte.forEach(m => {
                const tMin = periodStats.by_month["month_" + m];
                if (tMin <= agr.seuil_fruit) moisGeles.push({m, tMin});
                else moisSains.push(m);
            });

            let statut = "ok";
            let priorite = 1;

            if (!survitArbre) { statut = "ko"; priorite = 4; }
            else if (moisGeles.length === 0) { statut = "ok"; priorite = 1; }
            else if (moisSains.length > 0) { statut = "early"; priorite = 2; }
            else { statut = "warning"; priorite = 3; }

            return { ...agr, statut, priorite, moisGeles, moisSains };
        }).sort((a, b) => a.priorite - b.priorite);

        processed.forEach(agr => {
            const card = document.createElement('div');
            card.className = `agrume-card status-${agr.statut}`;

            const txtRecolte = agr.recolte.map(m => monthNames[m-1]).join('/');
            const badgeRecolte = `<span class="badge badge-recolte">R√©colte : ${txtRecolte}</span>`;

            if (agr.statut === "ko") {
                card.innerHTML = `<strong>‚ùå ${agr.nom}</strong><br><small>Arbre g√©lif (Limite : ${agr.seuil_arbre}¬∞C)</small><br>${badgeRecolte}`;
            } else if (agr.statut === "ok") {
                card.innerHTML = `<strong>‚úÖ ${agr.nom}</strong><br><small>R√©colte et arbre s√©curis√©s.</small><br>${badgeRecolte}`;
            } else if (agr.statut === "early") {
                const moisOK = agr.moisSains.map(m => monthNames[m-1]).join(', ');
                card.innerHTML = `<strong>‚ú® ${agr.nom}</strong><br><small>R√©colte possible avant le gel en : <b>${moisOK}</b>.</small><br>${badgeRecolte}`;
            } else {
                const alertes = agr.moisGeles.map(obj => `${monthNames[obj.m-1]} (<span class="temp-tag">${obj.tMin}¬∞C</span>)`).join(' ');
                card.innerHTML = `<strong>‚ö†Ô∏è ${agr.nom}</strong><br><small>Fruits syst√©matiquement gel√©s :</small><div style="margin-top:5px; font-size:0.85em;">${alertes}</div>${badgeRecolte}`;
            }
            container.appendChild(card);
        });
    }

    const legend = L.control({position: 'bottomleft'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const grades = [-20, -15, -12, -10, -8, -5, 0];
        div.innerHTML = '<h4>Minimales Station</h4>';
        for (let i = 0; i < grades.length; i++) {
            const color = getColor(grades[i] + 1);
            div.innerHTML += `<div class="legend-item"><i style="background: ${color}"></i><span>${grades[i+1] ? grades[i]+' √† '+grades[i+1] : '> '+grades[i]}¬∞C</span></div>`;
        }
        return div;
    };
    legend.addTo(map);
</script>
</body>
</html>
