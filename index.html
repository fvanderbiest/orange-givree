<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Orange givr√©e - Rusticit√© & R√©colte</title>

    <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='leafGradient' x1='0%' y1='0%' x2='100%' y2='100%'><stop offset='0%' style='stop-color:%234CAF50;stop-opacity:1' /><stop offset='100%' style='stop-color:%2366BB6A;stop-opacity:1' /></linearGradient><radialGradient id='dropGradient' cx='50%' cy='50%' r='50%' fx='50%' fy='50%'><stop offset='0%' style='stop-color:rgb(255,255,255);stop-opacity:0.9' /><stop offset='100%' style='stop-color:rgb(173,216,230);stop-opacity:0.6' /></radialGradient></defs><path d='M 30 70 Q 10 50 40 20 Q 70 5 90 30 Q 80 60 55 85 L 30 70 Z' fill='url(%23leafGradient)'/><circle cx='50' cy='50' r='10' fill='url(%23dropGradient)' stroke='%2387CEEB' stroke-width='1'/></svg>" type="image/svg+xml">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        :root { --primary: #c2410c; --bg: #f8fafc; --white: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; display: flex; height: 100vh; background: var(--bg); color: #1e293b; overflow: hidden; }
        #map { flex: 1; height: 100%; min-height: 300px; }
        #sidebar { width: 420px; background: var(--white); border-left: 1px solid #e2e8f0; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; z-index: 1000; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            #sidebar { width: 100%; height: 60vh; border-left: none; border-top: 2px solid #e2e8f0; padding: 15px; }
            #map { flex: none; height: 40vh; }
        }

        h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 1.4rem; display: flex; align-items: center; gap: 10px; }
        .intro-text { font-size: 0.85rem; line-height: 1.4; color: #64748b; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        .period-selector { padding: 12px; background: #fff7ed; border-radius: 12px; border: 1px solid #ffedd5; margin-bottom: 15px; }
        #station-info { margin-bottom: 15px; padding: 12px; background: #f1f5f9; border-radius: 12px; border: 1px solid #e2e8f0; }
        #station-name { color: #1e293b; font-weight: 800; font-size: 1.1em; display: block; }
        #search-container { margin-bottom: 15px; display: none; }
        #search-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; box-sizing: border-box; font-size: 0.9rem; outline: none; }

        .agrume-card { padding: 14px; margin-bottom: 10px; border-radius: 10px; background: var(--white); border: 1px solid #f1f5f9; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .status-ok { border-left: 5px solid #16a34a; background: #f0fdf4; }
        .status-early { border-left: 5px solid #eab308; background: #fffbeb; }
        .status-warning { border-left: 5px solid #f97316; background: #fff7ed; }
        .status-ko { border-left: 5px solid #ef4444; opacity: 0.8; background: #fef2f2; }

        .month-badges-container { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; }
        .m-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 800; color: white; text-transform: uppercase; display: flex; flex-direction: column; align-items: center; min-width: 32px; }
        .m-temp { font-size: 0.55rem; font-weight: 400; opacity: 0.9; }
        .m-green { background-color: #16a34a; }
        .m-orange { background-color: #f97316; }
        .m-red { background-color: #dc2626; }
        .m-grey { background-color: #94a3b8; }

        .limits-tag { font-size: 0.75rem; color: #94a3b8; font-weight: 400; margin-left: 8px; white-space: nowrap; }
        .legend { padding: 10px; background: var(--white); border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 0.75rem; line-height: 1.5; }
        .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
        .legend-item i { width: 12px; height: 12px; margin-right: 8px; border-radius: 50%; flex-shrink: 0; }

        .source-mention { font-size: 0.7rem; color: #94a3b8; margin-top: auto; padding-top: 15px; text-align: center; }
        select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #fed7aa; margin-top: 5px; cursor: pointer; font-size: 0.9rem; }
    </style>
</head>
<body>

<div id="map"></div>
<div id="sidebar">
    <h2>Orange givr√©e <span>‚ùÑÔ∏èüçä</span></h2>
    <div class="intro-text">
        Cette application croise les donn√©es historiques de <b>M√©t√©o-France</b> avec la r√©sistance au gel des agrumes.
        Elle permet de v√©rifier si une vari√©t√© peut survivre √† votre climat et si ses fruits pourront √™tre r√©colt√©s avant les grands froids.
    </div>
    <div class="period-selector">
        <label for="period-select"><small><b>FEN√äTRE D'ANALYSE :</b></small></label>
        <select id="period-select" onchange="refreshView()">
            <option value="last_5y" selected>Climat r√©cent (5 ans)</option>
            <option value="last_10y">Tendance (10 ans)</option>
            <option value="last_20y">Historique (20 ans)</option>
        </select>
    </div>
    <div id="station-info">
        <span id="station-name">Choisir une station sur la carte</span>
        <small id="min-display" style="color: #64748b;"></small>
    </div>
    <div id="search-container">
        <input type="text" id="search-input" placeholder="Filtrer les vari√©t√©s..." oninput="updateSidebarContent()">
    </div>
    <div id="agrumes-container">
        <p style="color: #94a3b8; font-style: italic; text-align: center; margin-top: 20px;">Cliquez sur un point pour lancer l'analyse.</p>
    </div>
    <div class="source-mention">
        Donn√©es compil√©es sur la p√©riode 2006-2026 (source <a href="https://www.data.gouv.fr/datasets/donnees-climatologiques-de-base-quotidiennes" target="_blank">M√©t√©o-France</a>)<br>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([46.5, 2.5], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
    }).addTo(map);

    let agrumesData = [];
    let geojsonData = null;
    let geojsonLayer = null;
    let currentFeature = null;
    const monthNames = ["Jan", "F√©v", "Mar", "Avr", "Mai", "Jun", "Jul", "Ao√ªt", "Sep", "Oct", "Nov", "D√©c"];

    function getMarkerColor(t) {
        if (t === null || t === undefined) return '#94a3b8';
        return t > 0 ? '#16a34a' : t > -5 ? '#84cc16' : t > -8 ? '#eab308' : t > -10 ? '#f97316' : t > -12 ? '#ef4444' : t > -15 ? '#dc2626' : '#7f1d1d';
    }

    // Chargement s√©curis√©
    Promise.all([
        fetch('agrumes.json').then(res => res.json()),
        fetch('stations_temperatures.geojson').then(res => res.json())
    ]).then(([agrumes, geojson]) => {
        agrumesData = agrumes;
        geojsonData = geojson;
        renderMap();
    }).catch(err => console.error("Erreur de chargement :", err));

    function renderMap() {
        if (!geojsonData) return;
        const period = document.getElementById('period-select').value;
        if (geojsonLayer) map.removeLayer(geojsonLayer);

        geojsonLayer = L.geoJSON(geojsonData, {
            filter: f => f.properties && f.properties[period] && f.properties[period].min_absolute !== null,
            pointToLayer: (f, latlng) => L.circleMarker(latlng, {
                radius: 8,
                fillColor: getMarkerColor(f.properties[period].min_absolute),
                color: "#fff",
                weight: 1,
                fillOpacity: 0.9
            }),
            onEachFeature: (f, layer) => {
                layer.on('click', () => {
                    currentFeature = f;
                    document.getElementById('search-container').style.display = 'block';
                    updateSidebarContent();
                });
                layer.bindTooltip(`<b>${f.properties.nom || 'Station inconnue'}</b>`, {direction:'top'});
            }
        }).addTo(map);
    }

    function refreshView() { renderMap(); if (currentFeature) updateSidebarContent(); }

    function updateSidebarContent() {
        if (!currentFeature || !currentFeature.properties) return;
        const period = document.getElementById('period-select').value;
        const periodStats = currentFeature.properties[period];
        if (!periodStats) return;

        const minAbs = periodStats.min_absolute;
        const searchQuery = document.getElementById('search-input').value.toLowerCase();
        const container = document.getElementById('agrumes-container');
        container.innerHTML = "";

        const processed = agrumesData
            .filter(agr => agr.nom.toLowerCase().includes(searchQuery))
            .map(agr => {
                const survitArbre = minAbs > agr.seuil_arbre;
                let moisBadges = [];
                let cumulGelRouge = false;
                let cumulGelOrange = false;

                const fullYearCycle = [9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8];
                fullYearCycle.forEach(m => {
                    const tMin = periodStats.by_month ? periodStats.by_month["month_" + m] : null;
                    const estDansRecolte = agr.recolte.includes(m);

                    if (tMin !== null) {
                        if (tMin < (agr.seuil_fruit - 1)) cumulGelRouge = true;
                        else if (tMin >= (agr.seuil_fruit - 1) && tMin <= (agr.seuil_fruit + 1)) cumulGelOrange = true;
                    }

                    if (estDansRecolte) {
                        let color = "m-green";
                        if (cumulGelRouge) color = "m-red";
                        else if (cumulGelOrange) color = "m-orange";
                        moisBadges.push({ month: m, name: monthNames[m-1], temp: tMin, color });
                    }
                });

                let statut = "ok", priorite = 1;
                const debutRecolte = moisBadges[0];
                const tousVerts = moisBadges.every(b => b.color === "m-green");
                const aDuFroidSeverement = moisBadges.some(b => b.temp !== null && b.temp < (agr.seuil_fruit - 2));

                if (!survitArbre) { statut = "ko"; priorite = 4; }
                else if (tousVerts) { statut = "ok"; priorite = 1; }
                else if (debutRecolte && (debutRecolte.color === "m-green" || debutRecolte.color === "m-orange")) {
                    statut = "early"; priorite = 2;
                } else { statut = "warning"; priorite = 3; }

                return { ...agr, statut, priorite, moisBadges, aDuFroidSeverement };
            })
            .sort((a, b) => a.priorite - b.priorite || a.seuil_arbre - b.seuil_arbre);

        document.getElementById('station-name').innerText = currentFeature.properties.nom || 'Station';
        document.getElementById('min-display').innerText = `Record local : ${minAbs}¬∞C`;

        processed.forEach(agr => {
            const card = document.createElement('div');
            card.className = `agrume-card status-${agr.statut}`;
            let msg = (agr.statut === "ko") ? "Vari√©t√© non adapt√©e" :
                      (agr.statut === "ok") ? "Vari√©t√© adapt√©e" :
                      (agr.statut === "early") ? "R√©colte pr√©coce imp√©rative" :
                      (agr.aDuFroidSeverement) ? "R√©colte impossible (gel total)" : "Risque de gel (surveillance n√©cessaire)";

            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items: baseline;">
                    <strong>${agr.nom.split('(')[0]}</strong>
                    <span class="limits-tag">Arbre : ${agr.seuil_arbre}¬∞ | Fruits : ${agr.seuil_fruit}¬∞</span>
                </div>
                <small style="color: #64748b;">${msg}</small>
                <div class="month-badges-container">${agr.moisBadges.map(m => `<div class="m-badge ${m.color}"><span>${m.name}</span><span class="m-temp">${m.temp !== null ? m.temp+'¬∞' : ''}</span></div>`).join('')}</div>`;
            container.appendChild(card);
        });
    }

    const legend = L.control({position: 'bottomleft'});
    legend.onAdd = function () {
        const div = L.DomUtil.create('div', 'legend');
        const grades = [-20, -15, -12, -10, -8, -5, 0];
        div.innerHTML = '<b>Minimales Absolues</b><br>';
        for (let i = 0; i < grades.length; i++) {
            const color = getMarkerColor(grades[i] + 1);
            div.innerHTML += `<div class="legend-item"><i style="background: ${color}"></i><span>${grades[i+1] ? grades[i]+' √† '+grades[i+1] : '> '+grades[i]}¬∞C</span></div>`;
        }
        return div;
    };
    legend.addTo(map);
</script>
</body>
</html>
